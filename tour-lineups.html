<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Team Lineups | PSL</title>

    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;800;900&family=Space+Grotesk:wght@300;400;500;600;700&family=Kanit:wght@200;300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

    <style>
        :root {
            --pure-black:  #000000;
            --deep-black:  #0a0a0a;
            --soft-black:  #111111;
            --charcoal:    #1a1a1a;
            --graphite:    #2a2a2a;
            --pure-white:  #ffffff;
            --soft-white:  rgba(255,255,255,0.9);
            --mist-white:  rgba(255,255,255,0.55);
            --frost-white: rgba(255,255,255,0.1);
            --ghost-white: rgba(255,255,255,0.05);
            --glass-bg:        rgba(255,255,255,0.03);
            --glass-border:    rgba(255,255,255,0.08);
            --glass-highlight: rgba(255,255,255,0.14);
            --glass-shadow:    rgba(0,0,0,0.4);
            --liquid-sheen: linear-gradient(135deg,rgba(255,255,255,0.08) 0%,rgba(255,255,255,0) 50%,rgba(255,255,255,0.04) 100%);
            --success: #10b981;
            --warning: #f59e0b;
            --font-display: 'Orbitron', sans-serif;
            --font-body:    'Space Grotesk','Kanit',sans-serif;
            --r-sm: 12px; --r-md: 20px; --r-lg: 28px; --r-xl: 40px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

        body {
            background: var(--deep-black);
            font-family: var(--font-body);
            color: var(--soft-white);
            overflow-x: hidden;
            padding-bottom: 100px;
        }

        body::before {
            content: '';
            position: fixed; top: -50%; left: -50%;
            width: 200%; height: 200%;
            background:
                radial-gradient(circle at 20% 80%, rgba(255,255,255,0.025) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255,255,255,0.02) 0%, transparent 50%);
            pointer-events: none; z-index: 0;
            animation: ambientMove 20s ease-in-out infinite;
        }
        @keyframes ambientMove {
            0%,100% { transform: translate(0,0) scale(1); }
            50%      { transform: translate(-2%,2%) scale(1.08); }
        }

        /* ── NAVBAR ── */
        .navbar {
            position: sticky; top: 0; z-index: 100;
            background: rgba(10,10,10,0.9);
            backdrop-filter: blur(24px) saturate(180%);
            border-bottom: 1px solid var(--glass-border);
            padding: 14px 20px;
            display: flex; align-items: center; justify-content: space-between;
            box-shadow: 0 4px 30px rgba(0,0,0,0.4);
        }
        .nav-back {
            display: flex; align-items: center; gap: 10px;
            color: var(--mist-white); font-size: 0.88rem;
            text-decoration: none; transition: color 0.2s;
        }
        .nav-back:hover { color: var(--pure-white); }
        .brand {
            font-family: var(--font-display); font-weight: 800;
            font-size: 1rem; color: var(--pure-white); letter-spacing: 2px;
        }
        .brand span { color: var(--mist-white); font-weight: 400; }
        .nav-home {
            width: 38px; height: 38px; border-radius: var(--r-sm);
            border: 1px solid var(--glass-border); background: var(--ghost-white);
            display: flex; align-items: center; justify-content: center;
            color: var(--mist-white); text-decoration: none; transition: all 0.3s;
        }
        .nav-home:hover { border-color: var(--glass-highlight); color: var(--pure-white); }

        /* ── HERO ── */
        .hero {
            position: relative; overflow: hidden;
            padding: 40px 20px 32px;
            border-bottom: 1px solid var(--glass-border);
            text-align: center;
        }
        .hero-banner-img {
            position: absolute; inset: 0;
            width: 100%; height: 100%; object-fit: cover;
            opacity: 0.08; filter: blur(2px); pointer-events: none;
        }
        .hero-content { position: relative; z-index: 1; }

        .hero-game-badge {
            display: inline-flex; align-items: center; gap: 6px;
            background: var(--ghost-white); border: 1px solid var(--glass-border);
            padding: 5px 14px; border-radius: 30px;
            font-size: 0.72rem; color: var(--mist-white);
            font-family: var(--font-display); letter-spacing: 2px; text-transform: uppercase;
            margin-bottom: 14px;
        }

        .hero-title {
            font-family: var(--font-display); font-weight: 900;
            font-size: clamp(1.3rem, 4vw, 2.2rem);
            color: var(--pure-white); letter-spacing: 1px;
            text-shadow: 0 0 30px rgba(255,255,255,0.15);
            margin-bottom: 6px;
        }

        /* Stats row */
        .stats-row {
            display: flex; justify-content: center; gap: 12px;
            margin-top: 24px; flex-wrap: wrap;
        }
        .stat-pill {
            background: var(--glass-bg); border: 1px solid var(--glass-border);
            border-radius: var(--r-md); padding: 14px 24px; text-align: center;
            min-width: 100px; transition: all 0.3s;
        }
        .stat-pill:hover {
            border-color: var(--glass-highlight); transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .stat-val {
            font-family: var(--font-display); font-weight: 800;
            font-size: 1.8rem; color: var(--pure-white); line-height: 1;
        }
        .stat-lbl {
            font-size: 0.68rem; color: var(--mist-white);
            text-transform: uppercase; letter-spacing: 2px; margin-top: 5px;
            font-family: var(--font-display);
        }

        /* Slot progress */
        .slot-bar-wrap {
            max-width: 340px; margin: 20px auto 0;
        }
        .slot-bar-header {
            display: flex; justify-content: space-between;
            font-size: 0.78rem; color: var(--mist-white); margin-bottom: 7px;
        }
        .slot-bar-header b { color: var(--pure-white); }
        .slot-track {
            height: 6px; background: rgba(255,255,255,0.08); border-radius: 6px; overflow: hidden;
        }
        .slot-fill {
            height: 100%; border-radius: 6px;
            background: linear-gradient(90deg, var(--pure-white), rgba(255,255,255,0.5));
            transition: width 1s ease;
        }

        /* ── SEARCH / FILTER ── */
        .toolbar {
            max-width: 860px; margin: 28px auto 0; padding: 0 16px;
            display: flex; gap: 10px; align-items: center;
        }
        .search-wrap {
            flex: 1; position: relative;
        }
        .search-wrap i {
            position: absolute; left: 14px; top: 50%; transform: translateY(-50%);
            color: var(--mist-white); font-size: 0.9rem; pointer-events: none;
        }
        .search-input {
            width: 100%; padding: 11px 14px 11px 38px;
            background: var(--ghost-white); border: 1px solid var(--glass-border);
            border-radius: var(--r-sm); color: var(--soft-white);
            font-family: var(--font-body); font-size: 0.9rem;
            transition: all 0.3s;
        }
        .search-input::placeholder { color: var(--mist-white); }
        .search-input:focus {
            outline: none; border-color: var(--glass-highlight);
            background: rgba(255,255,255,0.07);
            box-shadow: 0 0 0 3px rgba(255,255,255,0.04);
        }
        .filter-pill {
            padding: 10px 16px; border-radius: var(--r-sm);
            border: 1px solid var(--glass-border); background: var(--ghost-white);
            color: var(--mist-white); font-size: 0.8rem; font-weight: 700;
            cursor: pointer; transition: all 0.2s; white-space: nowrap;
            font-family: var(--font-display); letter-spacing: 1px; text-transform: uppercase;
        }
        .filter-pill.active, .filter-pill:hover {
            border-color: var(--glass-highlight); color: var(--pure-white);
            background: rgba(255,255,255,0.08);
        }
        .filter-pill.active { background: var(--pure-white); color: var(--pure-black); }

        /* ── MAIN GRID ── */
        .main { max-width: 860px; margin: 0 auto; padding: 20px 16px; }

        .section-label {
            font-family: var(--font-display); font-weight: 700; font-size: 0.78rem;
            color: var(--mist-white); letter-spacing: 2px; text-transform: uppercase;
            margin-bottom: 14px; display: flex; align-items: center; gap: 10px;
        }
        .section-label::after {
            content: ''; flex: 1; height: 1px;
            background: linear-gradient(90deg, var(--glass-border), transparent);
        }

        /* ── TEAM CARD ── */
        .team-card {
            background: var(--glass-bg);
            backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid var(--glass-border);
            border-radius: var(--r-lg);
            margin-bottom: 14px;
            transition: all 0.35s cubic-bezier(0.4,0,0.2,1);
            position: relative; overflow: hidden;
        }
        .team-card::before {
            content: ''; position: absolute; top: 0; left: -100%;
            width: 100%; height: 100%;
            background: var(--liquid-sheen); transition: left 0.7s; pointer-events: none;
        }
        .team-card:hover::before { left: 100%; }
        .team-card:hover {
            border-color: var(--glass-highlight);
            box-shadow: 0 12px 40px rgba(0,0,0,0.35), 0 0 20px rgba(255,255,255,0.03);
            transform: translateY(-3px);
        }

        .card-header {
            display: flex; align-items: center; gap: 14px;
            padding: 18px 20px; cursor: pointer;
        }

        .rank-num {
            font-family: var(--font-display); font-weight: 800; font-size: 1.1rem;
            color: var(--mist-white); min-width: 28px; text-align: center;
        }
        .rank-num.gold   { color: #ffd700; text-shadow: 0 0 12px rgba(255,215,0,0.4); }
        .rank-num.silver { color: #c0c0c0; }
        .rank-num.bronze { color: #cd7f32; }

        .team-logo {
            width: 52px; height: 52px; border-radius: 50%;
            object-fit: cover; border: 1.5px solid var(--glass-border);
            background: var(--charcoal); flex-shrink: 0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        .team-meta { flex: 1; min-width: 0; }
        .team-name {
            font-weight: 700; font-size: 1rem; color: var(--pure-white);
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .team-sub {
            font-size: 0.78rem; color: var(--mist-white);
            display: flex; align-items: center; gap: 8px; margin-top: 3px;
            flex-wrap: wrap;
        }
        .tag-chip {
            font-family: var(--font-display); font-size: 0.65rem;
            color: var(--soft-white); letter-spacing: 1px;
            background: var(--ghost-white); border: 1px solid var(--glass-border);
            padding: 2px 8px; border-radius: 6px;
        }

        .status-badge {
            display: inline-flex; align-items: center; gap: 5px;
            padding: 4px 10px; border-radius: 20px;
            font-size: 0.65rem; font-weight: 700;
            font-family: var(--font-display); letter-spacing: 1px; text-transform: uppercase;
            flex-shrink: 0;
        }
        .badge-approved { background: rgba(16,185,129,0.12); color: var(--success); border: 1px solid rgba(16,185,129,0.3); }
        .badge-pending  { background: rgba(245,158,11,0.10); color: var(--warning);  border: 1px solid rgba(245,158,11,0.25); }
        .dot-pulse { width: 6px; height: 6px; border-radius: 50%; background: currentColor; animation: dp 1.4s ease infinite; }
        @keyframes dp { 0%,100%{opacity:1;transform:scale(1)} 50%{opacity:0.4;transform:scale(0.6)} }

        /* Player avatars row */
        .avatars-row {
            display: flex; align-items: center; gap: 0;
        }
        .av {
            width: 28px; height: 28px; border-radius: 50%;
            background: var(--graphite); border: 2px solid var(--charcoal);
            display: flex; align-items: center; justify-content: center;
            font-size: 0.65rem; color: var(--mist-white); margin-left: -8px;
            font-family: var(--font-display); font-weight: 700; flex-shrink: 0;
        }
        .av:first-child { margin-left: 0; }
        .av.more {
            background: var(--ghost-white); border-color: var(--glass-border);
            font-size: 0.6rem; color: var(--mist-white); letter-spacing: 0;
        }
        .av.captain { background: rgba(255,255,255,0.15); border-color: rgba(255,255,255,0.3); }

        /* Toggle chevron */
        .toggle-btn {
            width: 36px; height: 36px; border-radius: 10px;
            border: 1px solid var(--glass-border); background: var(--ghost-white);
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; color: var(--mist-white); transition: all 0.25s;
            flex-shrink: 0;
        }
        .toggle-btn:hover { border-color: var(--glass-highlight); color: var(--pure-white); }
        .toggle-btn i { transition: transform 0.3s; }
        .team-card.open .toggle-btn i { transform: rotate(180deg); }

        /* ── LINEUP PANEL ── */
        .lineup-panel {
            max-height: 0; overflow: hidden;
            transition: max-height 0.4s cubic-bezier(0.4,0,0.2,1), opacity 0.3s;
            opacity: 0;
        }
        .team-card.open .lineup-panel { max-height: 600px; opacity: 1; }

        .lineup-inner {
            padding: 0 20px 20px;
            border-top: 1px solid var(--glass-border);
        }

        .lineup-section-label {
            font-family: var(--font-display); font-size: 0.65rem;
            color: var(--mist-white); letter-spacing: 2px;
            text-transform: uppercase; padding: 14px 0 10px;
        }

        .player-row {
            display: flex; align-items: center; gap: 12px;
            padding: 10px 12px; border-radius: var(--r-sm);
            transition: background 0.2s; margin-bottom: 6px;
        }
        .player-row:last-child { margin-bottom: 0; }
        .player-row:hover { background: var(--ghost-white); }

        .player-role-tag {
            font-family: var(--font-display); font-size: 0.6rem;
            font-weight: 800; letter-spacing: 1px; text-transform: uppercase;
            padding: 3px 8px; border-radius: 6px; flex-shrink: 0; min-width: 62px; text-align: center;
        }
        .role-captain { background: var(--pure-white); color: var(--pure-black); }
        .role-member  { background: rgba(255,255,255,0.08); color: var(--soft-white); border: 1px solid var(--glass-border); }
        .role-sub     { background: rgba(255,255,255,0.04); color: var(--mist-white); border: 1px solid rgba(255,255,255,0.06); }

        .player-ign   { font-weight: 600; font-size: 0.92rem; color: var(--soft-white); flex: 1; }
        .player-uid   { font-size: 0.75rem; color: var(--mist-white); font-family: monospace; }

        /* ── EMPTY / LOADING ── */
        .empty-state {
            text-align: center; padding: 60px 20px;
            background: var(--glass-bg); border: 1px dashed var(--glass-border);
            border-radius: var(--r-lg); color: var(--mist-white);
        }
        .empty-state i { font-size: 3rem; display: block; margin-bottom: 14px; opacity: 0.3; }
        .empty-state h3 {
            font-family: var(--font-display); font-size: 1.1rem;
            color: var(--pure-white); margin-bottom: 6px; letter-spacing: 1px;
        }
        .loader { text-align: center; padding: 60px 20px; color: var(--mist-white); }
        .loader i { font-size: 2rem; display: block; margin-bottom: 12px; }

        /* ── BOTTOM NAV ── */
        .bottom-nav {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: calc(100% - 40px); max-width: 500px;
            background: rgba(10,10,10,0.85); backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border); border-radius: var(--r-xl);
            display: flex; justify-content: space-around; padding: 12px 8px;
            z-index: 50; box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }
        .nav-item {
            flex: 1; display: flex; flex-direction: column; align-items: center;
            gap: 4px; color: var(--mist-white); text-decoration: none;
            font-size: 0.63rem; font-family: var(--font-display); letter-spacing: 1px;
            text-transform: uppercase; padding: 6px 8px; border-radius: var(--r-md);
            transition: all 0.3s;
        }
        .nav-item i { font-size: 1.2rem; transition: all 0.3s; }
        .nav-item.active { color: var(--pure-white); background: rgba(255,255,255,0.08); }
        .nav-item.active i { transform: translateY(-3px); text-shadow: 0 0 12px rgba(255,255,255,0.4); }
        .nav-item:hover:not(.active) { color: var(--soft-white); }

        @media(max-width:480px) {
            .stats-row { gap: 8px; }
            .stat-pill { padding: 12px 16px; min-width: 80px; }
            .stat-val { font-size: 1.5rem; }
        }
    </style>
</head>
<body>

    <!-- NAVBAR -->
    <nav class="navbar">
        <a href="javascript:history.back()" class="nav-back">
            <i class="fa-solid fa-arrow-left"></i> Back
        </a>
        <div class="brand">PSL <span>Teams</span></div>
        <a href="index.html" class="nav-home"><i class="fa-solid fa-house"></i></a>
    </nav>

    <!-- HERO -->
    <div class="hero">
        <img id="heroBg" src="" class="hero-banner-img" alt="" style="display:none;">
        <div class="hero-content">
            <div class="hero-game-badge" id="gameBadge">
                <i class="fa-solid fa-gamepad"></i> <span id="gameLabel">Loading...</span>
            </div>
            <div class="hero-title" id="tourTitle">Tournament Teams</div>

            <div class="stats-row">
                <div class="stat-pill">
                    <div class="stat-val" id="statTeams">—</div>
                    <div class="stat-lbl">Teams</div>
                </div>
                <div class="stat-pill">
                    <div class="stat-val" id="statPlayers">—</div>
                    <div class="stat-lbl">Players</div>
                </div>
                <div class="stat-pill">
                    <div class="stat-val" id="statSlots">—</div>
                    <div class="stat-lbl">Slots Left</div>
                </div>
            </div>

            <div class="slot-bar-wrap">
                <div class="slot-bar-header">
                    <span>Slots Filled</span>
                    <b id="slotText">0 / 0</b>
                </div>
                <div class="slot-track">
                    <div class="slot-fill" id="slotFill" style="width:0%"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- TOOLBAR -->
    <div class="toolbar">
        <div class="search-wrap">
            <i class="fa-solid fa-magnifying-glass"></i>
            <input type="text" class="search-input" id="searchInput" placeholder="ค้นหาทีม...">
        </div>
        <button class="filter-pill active" id="filterAll" onclick="setFilter('all', this)">All</button>
        <button class="filter-pill" id="filterApproved" onclick="setFilter('approved', this)">
            <i class="fa-solid fa-check"></i> Confirmed
        </button>
    </div>

    <!-- MAIN -->
    <div class="main">
        <div class="section-label" id="sectionLabel">Registered Teams</div>
        <div id="teamsContainer">
            <div class="loader">
                <i class="fa-solid fa-circle-notch fa-spin"></i>
                <div>Loading teams...</div>
            </div>
        </div>
    </div>

    <!-- BOTTOM NAV -->
    <nav class="bottom-nav">
        <a href="index.html" class="nav-item"><i class="fa-solid fa-house"></i><span>Home</span></a>
        <a href="scrims.html" class="nav-item"><i class="fa-solid fa-handshake-simple"></i><span>Scrims</span></a>
        <a href="tournaments.html" class="nav-item active"><i class="fa-solid fa-trophy"></i><span>Tourneys</span></a>
        <a href="manager.html" class="nav-item"><i class="fa-solid fa-user-gear"></i><span>Manage</span></a>
    </nav>

    <script type="module">
        import { db } from './firebase-config.js';
        import { doc, getDoc, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const params = new URLSearchParams(location.search);
        const tourId = params.get('id');

        let allTeams = [];
        let currentFilter = 'all';
        let tourData = null;

        // ── Boot ─────────────────────────────────────────────────────────────
        if (!tourId) {
            document.getElementById('teamsContainer').innerHTML = `
                <div class="empty-state">
                    <i class="fa-solid fa-triangle-exclamation"></i>
                    <h3>ไม่พบ Tournament ID</h3>
                    <p>กลับไปที่หน้า Tournaments และเลือกทัวร์อีกครั้ง</p>
                </div>`;
        } else {
            loadPage();
        }

        // ── Load All Data ─────────────────────────────────────────────────────
        async function loadPage() {
            try {
                // 1. Tournament info
                const tourSnap = await getDoc(doc(db, 'tournaments', tourId));
                if (tourSnap.exists()) {
                    tourData = tourSnap.data();
                    renderHero(tourData);
                }

                // 2. Registrations (stores roster inline — no extra fetch needed)
                const regQ = query(collection(db, 'registrations'), where('tournamentId', '==', tourId));
                const regSnap = await getDocs(regQ);

                allTeams = regSnap.docs.map((d, i) => ({
                    _regId: d.id,
                    _rank: i + 1,
                    ...d.data()
                }));

                // Sort: approved first, then pending
                allTeams.sort((a, b) => {
                    if (a.status === b.status) return 0;
                    return a.status === 'approved' ? -1 : 1;
                });

                // Stats
                const totalPlayers = allTeams.reduce((s, t) => s + (t.roster?.length || 0), 0);
                const maxTeams = tourData?.maxTeams || 32;
                const cur = allTeams.length;

                document.getElementById('statTeams').textContent   = cur;
                document.getElementById('statPlayers').textContent  = totalPlayers;
                document.getElementById('statSlots').textContent    = Math.max(0, maxTeams - cur);
                document.getElementById('slotText').textContent     = `${cur} / ${maxTeams}`;
                const pct = Math.min((cur / maxTeams) * 100, 100);
                setTimeout(() => { document.getElementById('slotFill').style.width = pct + '%'; }, 100);

                renderTeams(allTeams);

            } catch (e) {
                console.error(e);
                document.getElementById('teamsContainer').innerHTML = `
                    <div class="empty-state">
                        <i class="fa-solid fa-triangle-exclamation"></i>
                        <h3>Error Loading</h3>
                        <p>${e.message}</p>
                    </div>`;
            }
        }

        // ── Render Hero ───────────────────────────────────────────────────────
        function renderHero(t) {
            document.getElementById('tourTitle').textContent    = t.title || 'Tournament';
            document.getElementById('gameLabel').textContent    = t.game  || 'Esports';
            if (t.img) {
                const bg = document.getElementById('heroBg');
                bg.src = t.img; bg.style.display = 'block';
            }
            document.title = `${t.title || 'Teams'} | PSL`;
        }

        // ── Render Teams ──────────────────────────────────────────────────────
        function renderTeams(teams) {
            const container  = document.getElementById('teamsContainer');
            const search     = document.getElementById('searchInput').value.toLowerCase();
            const filtered   = teams.filter(t => {
                const matchFilter = currentFilter === 'all' || t.status === currentFilter;
                const matchSearch = !search ||
                    (t.teamName || '').toLowerCase().includes(search) ||
                    (t.teamTag  || '').toLowerCase().includes(search);
                return matchFilter && matchSearch;
            });

            document.getElementById('sectionLabel').textContent =
                `${filtered.length} Team${filtered.length !== 1 ? 's' : ''}`;

            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fa-solid fa-users-slash"></i>
                        <h3>ยังไม่มีทีมสมัคร</h3>
                        <p>เป็นทีมแรกที่ลงทะเบียนสำหรับทัวร์นี้!</p>
                    </div>`;
                return;
            }

            container.innerHTML = filtered.map((team, idx) => {
                const roster  = team.roster || [];
                const mains   = roster.filter(p => p.role !== 'Sub');
                const subs    = roster.filter(p => p.role === 'Sub');
                const rankClass = idx === 0 ? 'gold' : idx === 1 ? 'silver' : idx === 2 ? 'bronze' : '';
                const isApproved = team.status === 'approved';

                const statusBadge = isApproved
                    ? `<span class="status-badge badge-approved"><span class="dot-pulse"></span> Confirmed</span>`
                    : `<span class="status-badge badge-pending"><i class="fa-solid fa-clock" style="font-size:0.6rem;"></i> Pending</span>`;

                // Avatar chips (max 5)
                const avatarShow = roster.slice(0, 5);
                const avatarsHtml = avatarShow.map((p, i) =>
                    `<div class="av ${i === 0 ? 'captain' : ''}" title="${p.ign || 'Player'}">${(p.ign || 'P').charAt(0).toUpperCase()}</div>`
                ).join('') + (roster.length > 5
                    ? `<div class="av more">+${roster.length - 5}</div>` : '');

                // Lineup rows
                const mainRows = mains.map(p => `
                    <div class="player-row">
                        <span class="player-role-tag ${p.role === 'Captain' ? 'role-captain' : 'role-member'}">${p.role}</span>
                        <span class="player-ign">${p.ign || '—'}</span>
                        <span class="player-uid">${p.uid ? '#' + p.uid : ''}</span>
                    </div>`).join('');

                const subRows = subs.length > 0 ? `
                    <div class="lineup-section-label">Substitutes</div>
                    ${subs.map(p => `
                        <div class="player-row">
                            <span class="player-role-tag role-sub">Sub</span>
                            <span class="player-ign">${p.ign || '—'}</span>
                            <span class="player-uid">${p.uid ? '#' + p.uid : ''}</span>
                        </div>`).join('')}` : '';

                return `
                    <div class="team-card animate__animated animate__fadeInUp" style="animation-delay:${idx * 0.04}s" id="card_${team._regId}">
                        <div class="card-header" onclick="toggleCard('${team._regId}')">
                            <div class="rank-num ${rankClass}">${idx + 1}</div>
                            <img src="${team.teamLogo || `https://placehold.co/52/111/fff?text=${(team.teamTag || 'T').charAt(0)}`}"
                                 class="team-logo"
                                 onerror="this.src='https://placehold.co/52/111/fff?text=T'">
                            <div class="team-meta">
                                <div class="team-name">${team.teamName || 'Unknown Team'}</div>
                                <div class="team-sub">
                                    ${team.teamTag ? `<span class="tag-chip">${team.teamTag}</span>` : ''}
                                    <div class="avatars-row">${avatarsHtml}</div>
                                    <span>${roster.length} player${roster.length !== 1 ? 's' : ''}</span>
                                </div>
                            </div>
                            ${statusBadge}
                            <div class="toggle-btn">
                                <i class="fa-solid fa-chevron-down"></i>
                            </div>
                        </div>
                        <div class="lineup-panel">
                            <div class="lineup-inner">
                                <div class="lineup-section-label">Starting Lineup</div>
                                ${mainRows || '<div style="color:var(--mist-white);font-size:0.85rem;padding:8px 0;">No lineup data</div>'}
                                ${subRows}
                            </div>
                        </div>
                    </div>`;
            }).join('');
        }

        // ── Toggle Card ───────────────────────────────────────────────────────
        window.toggleCard = (regId) => {
            const card = document.getElementById('card_' + regId);
            if (!card) return;
            // close others
            document.querySelectorAll('.team-card.open').forEach(c => {
                if (c !== card) c.classList.remove('open');
            });
            card.classList.toggle('open');
        };

        // ── Filter ────────────────────────────────────────────────────────────
        window.setFilter = (filter, btn) => {
            currentFilter = filter;
            document.querySelectorAll('.filter-pill').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            renderTeams(allTeams);
        };

        // ── Search ────────────────────────────────────────────────────────────
        document.getElementById('searchInput').addEventListener('input', () => renderTeams(allTeams));
    </script>
</body>
</html>
